<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Codex Manager</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism.css" rel="stylesheet" />
</head>
<body>
  <div class="container">
    <h1>üìÅ Codex File Manager</h1>

    <div class="toolbar">
      <button onclick="toggleTheme()">üåì Toggle Theme</button>
      <button onclick="toggleAddUI()">‚ûï Add New File</button>
    </div>

    <div id="projects">Loading projects...</div>

    <!-- Add File UI -->
    <div id="add-ui" class="hidden">
      <h2>‚ûï Create New File</h2>
      <label>Folder Name: <input id="folder-input" placeholder="e.g. naturtint_site" /></label><br>
      <label>File Name: <input id="file-input" placeholder="e.g. script.js" /></label><br>
      <label>Code:</label><br>
      <textarea id="code-input" placeholder="Paste your code here..."></textarea><br>
      <button onclick="pushToGitHub()">üöÄ Push to GitHub</button>
    </div>

    <!-- Code Viewer -->
    <div id="code-viewer"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js"></script>
  <script>
    const repoOwner = "Dave8011";
    const repoName = "Codex";
    const codesPath = "Codes";

    async function fetchJSON(url) {
      const res = await fetch(url);
      return res.json();
    }

    async function loadProjects() {
      const container = document.getElementById("projects");
      container.innerHTML = "";

      const folders = await fetchJSON(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${codesPath}`);

      for (const folder of folders) {
        if (folder.type === "dir") {
          const files = await fetchJSON(folder.url);
          const div = document.createElement("div");
          div.className = "project";
          div.innerHTML = `<h2>${folder.name}</h2><ul></ul>`;
          for (const file of files) {
            const li = document.createElement("li");
            li.innerHTML = `<button onclick="showCode('${file.name}', '${file.download_url}')">${file.name}</button>`;
            div.querySelector("ul").appendChild(li);
          }
          container.appendChild(div);
        }
      }
    }

    async function showCode(fileName, url) {
      const code = await fetch(url).then(r => r.text());
      const ext = fileName.split('.').pop();
      const highlighted = Prism.highlight(code, Prism.languages[ext] || Prism.languages.markup, ext);
      document.getElementById("code-viewer").innerHTML = `
        <h3>üìÑ ${fileName}</h3>
        <pre><code class="language-${ext}">${highlighted}</code></pre>
      `;
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
    }

    function toggleAddUI() {
      document.getElementById("add-ui").classList.toggle("hidden");
    }

    async function pushToGitHub() {
      const folder = document.getElementById("folder-input").value.trim();
      const file = document.getElementById("file-input").value.trim();
      const code = document.getElementById("code-input").value;

      if (!folder || !file || !code) {
        alert("All fields are required.");
        return;
      }

      const fullPath = `${codesPath}/${folder}/${file}`;

      const res = await fetch("/api/push-file", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: fullPath, content: code })
      });

      const result = await res.json();
      alert(result.message || "Done!");
      loadProjects(); // Reload UI
    }

    loadProjects();
  </script>
</body>
</html>
